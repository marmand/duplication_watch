#! /usr/bin/python3

import psycopg2
import hashlib

def md5(fname):
    hash_md5 = hashlib.md5()
    with open(fname, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_md5.update(chunk)
    return hash_md5.hexdigest()

connection = None
try:
    update = """
        UPDATE find_duplicates.files
        SET md5sum=%s
        WHERE path=%s
    """
    connection = psycopg2.connect("dbname=find_duplicates user=armand")
    with connection:
        with connection.cursor() as cursor:
            cursor.execute("SELECT path FROM find_duplicates.files WHERE md5sum IS NULL AND type='f' LIMIT 1000")
            for row in cursor.fetchall():
                cursor.execute(update, (md5(row[0]), row))
except psycopg2.DatabaseError as error:
    print(error)
finally:
    if connection is not None:
        connection.close()
